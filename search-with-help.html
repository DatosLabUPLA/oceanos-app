<!DOCTYPE html>
<html lang="es">
    <head>
        <meta charset="utf-8">
        <meta content="width=device-width, initial-scale=1.0" name="viewport">
        <title>App Océano - Buscador</title>
        <meta content="" name="description">
        <meta content="" name="keywords">

        <!-- Favicons -->
        <link href="assets/img/favicon.png" rel="icon">
        <link href="assets/img/apple-touch-icon.png" rel="apple-touch-icon">

        <!-- Google Fonts -->
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Open+Sans:ital,wght@0,300;0,400;0,500;0,600;0,700;1,300;1,400;1,600;1,700&family=Roboto:ital,wght@0,300;0,400;0,500;0,600;0,700;1,300;1,400;1,500;1,600;1,700&family=Work+Sans:ital,wght@0,300;0,400;0,500;0,600;0,700;1,300;1,400;1,500;1,600;1,700&display=swap" rel="stylesheet">

        <!-- Vendor CSS Files -->
        <link href="assets/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
        <link href="assets/vendor/bootstrap-icons/bootstrap-icons.css" rel="stylesheet">
        <link href="assets/vendor/fontawesome-free/css/all.min.css" rel="stylesheet">
        <link href="assets/vendor/aos/aos.css" rel="stylesheet">
        <link href="assets/vendor/glightbox/css/glightbox.min.css" rel="stylesheet">
        <link href="assets/vendor/swiper/swiper-bundle.min.css" rel="stylesheet">

        <!-- Template Main CSS File -->
        <link href="assets/css/main.css" rel="stylesheet">
        <link href="assets/css/mobile.css" rel="stylesheet">
        
        <style>
            /* Custom styles for search results */
            .species-card {
                transition: transform 0.3s ease, box-shadow 0.3s ease;
                cursor: pointer;
                height: 100%;
            }
            .species-card:hover {
                transform: scale(1.05);
                box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            }
            .species-card .card-img-top {
                height: 200px;
                object-fit: cover;
            }
            .species-card-link {
                text-decoration: none;
                color: inherit;
            }
            .species-card-link:hover {
                text-decoration: none;
            }
            #search-results {
                margin-top: 20px;
            }
            @media (max-width: 768px) {
                .species-card {
                    margin-bottom: 15px;
                }
            }
        </style>
    </head>

    <body class="bodyone d-flex p-5">
        <!-- ======= Header ======= -->
        <header id="header" class="header d-flex align-items-center">
            <div class="container-sm d-flex align-items-center justify-content-between">
                <div>
                    <a href="index.html" class="logo d-flex align-items-center">
                        <img src="assets/img/LOGO-APP-OCEANOS.png" alt="Logo app oceanos">
                    </a>
                </div>
                <i class="mobile-nav-toggle mobile-nav-show bi bi-list"></i>
                <i class="mobile-nav-toggle mobile-nav-hide d-none bi bi-x"></i>
                <nav id="navbar" class="navbar">
                    <ul>
                        <li><a href="mobile.html">Inicio</a></li>
                        <li><a href="search_FlorayFauna.html">Flora y Fauna</a></li>
                        <li><a href="search-with-help.html" class="active">Buscador con Ayuda</a></li>
                        <li><a href="desafios.html">Desafíos</a></li>
                        <li><a href="index.html#contact">Contáctanos</a></li>
                    </ul>
                </nav>
            </div>
        </header>

        <div class="container">
            <div class="row">
                <div class="col-12 text-center pt-5">
                    <h1>Buscador de Especies</h1>
                </div>
            </div>
            
            <form id="search-with-help">
                <!-- Categoría -->
                <div class="row mb-3">
                    <div class="col-4">
                        <label for="categoria" class="form-label">Categoría</label>
                    </div>
                    <div class="col-8">
                        <select class="form-control" id="categoria" name="categoria">
                            <option value="">Seleccione una categoría</option>
                            <!-- Opciones dinámicas agregadas por JavaScript -->
                        </select>
                    </div>
                </div>
        
                <!-- Tipo -->
                <div class="row mb-3">
                    <div class="col-4">
                        <label for="tipo" class="form-label">Tipo</label>
                    </div>
                    <div class="col-8">
                        <select class="form-control" id="tipo" name="tipo">
                            <option value="">Seleccione un tipo</option>
                            <!-- Opciones dinámicas agregadas por JavaScript -->
                        </select>
                    </div>
                </div>
        
                <!-- Nombre Común -->
                <!-- <div class="row mb-3">
                    <div class="col-4">
                        <label for="nombre_comun" class="form-label">Nombre Común</label>
                    </div>
                    <div class="col-8">
                        <input type="text" class="form-control" id="nombre_comun" name="nombre_comun" placeholder="Nombre Común">
                    </div>
                </div> -->
        
                <!-- Nombre Científico -->
                <!-- <div class="row mb-3">
                    <div class="col-4">
                        <label for="nombre_cientifico" class="form-label">Nombre Científico</label>
                    </div>
                    <div class="col-8">
                        <input type="text" class="form-control" id="nombre_cientifico" name="nombre_cientifico" placeholder="Nombre Científico">
                    </div>
                </div> -->
        
                <!-- Botón de búsqueda -->
                <div class="text-center pt-5">
                    <button type="submit" class="butonsearch btn col-10">Ver resultados</button>
                </div>
            </form>
        
            <!-- Contenedor de resultados -->
            <div id="search-results" class="mt-4"></div>
        </div>
        

        <!-- Vendor JS Files -->
        <script src="assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
        <script src="assets/vendor/aos/aos.js"></script>
        <script src="assets/vendor/glightbox/js/glightbox.min.js"></script>
        <script src="assets/vendor/isotope-layout/isotope.pkgd.min.js"></script>
        <script src="assets/vendor/swiper/swiper-bundle.min.js"></script>
        <script src="assets/vendor/purecounter/purecounter_vanilla.js"></script>
        <script src="assets/vendor/php-email-form/validate.js"></script>

        <script>
            // Utility function to remove accents and normalize text
            function normalizeText(text) {
                // Check if text is null or undefined
                if (!text) return '';
                
                return text.toString().toLowerCase()
                    .trim()
                    .normalize('NFD')
                    .replace(/[\u0300-\u036f]/g, '');
            }

            document.addEventListener('DOMContentLoaded', function () {
                const categoriaSelect = document.getElementById('categoria');
                const tipoSelect = document.getElementById('tipo');

                // Fetch available filters from the API
                fetch('https://oceanos-api.datoslab.cl/filters/', {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    // Populate "Categoría" options
                    if (data.categorias && Array.isArray(data.categorias)) {
                        data.categorias.forEach(categoria => {
                            const option = document.createElement('option');
                            option.value = categoria;
                            option.textContent = categoria.charAt(0).toUpperCase() + categoria.slice(1); // Capitalize
                            categoriaSelect.appendChild(option);
                        });
                    }

                    // Populate "Tipo" options
                    if (data.tipos && Array.isArray(data.tipos)) {
                        data.tipos.forEach(tipo => {
                            const option = document.createElement('option');
                            option.value = tipo;
                            option.textContent = tipo.charAt(0).toUpperCase() + tipo.slice(1); // Capitalize
                            tipoSelect.appendChild(option);
                        });
                    }
                })
                .catch(error => {
                    console.error('Error fetching filters:', error);
                });

                // Existing form submission logic
                const form = document.getElementById('search-with-help');
                const resultContainer = document.getElementById('search-results');

                form.addEventListener('submit', function (event) {
                    event.preventDefault();

                    const searchParams = {};
                    ['categoria', 'tipo', 'nombre_comun', 'nombre_cientifico'].forEach(function (field) {
                        const value = document.getElementById(field).value.trim();
                        if (value) {
                            searchParams[field] = value;
                        }
                    });

                    if (Object.keys(searchParams).length === 0) {
                        resultContainer.innerHTML = '<div class="alert alert-warning">Por favor, ingrese al menos un criterio de búsqueda.</div>';
                        return;
                    }

                    const queryString = Object.keys(searchParams)
                        .map(key => `${encodeURIComponent(key)}=${encodeURIComponent(searchParams[key])}`)
                        .join('&');

                    resultContainer.innerHTML = '<div class="text-center"><div class="spinner-border" role="status"><span class="sr-only">Cargando...</span></div></div>';

                    fetch(`https://oceanos-api.datoslab.cl/search/?${queryString}`, {
                        method: 'GET',
                        headers: {
                            'Accept': 'application/json',
                            'Content-Type': 'application/json'
                        }
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data.length > 0) {
                            let resultsHTML = '<h2>Resultados de la búsqueda:</h2>';
                            resultsHTML += '<div class="row">';

                            data.forEach(item => {
                                resultsHTML += `
                                    <div class="col-md-4 mb-4">
                                        <a href="detalle.html?id=${escapeHTML(item.ID)}" class="species-card-link">
                                            <div class="card species-card">
                                                <img src="IMAGENES/${escapeHTML(item.Url_Imagen)}" 
                                                    class="card-img-top" 
                                                    alt="${escapeHTML(item.Nombre_Comun)}"
                                                    onerror="this.src='assets/img/placeholder-image.png';">
                                                <div class="card-body">
                                                    <h5 class="card-title">${escapeHTML(item.Nombre_Comun) || 'Sin nombre común'}</h5>
                                                    <h6 class="card-subtitle mb-2 text-muted">${escapeHTML(item.Nombre_Cientifico) || 'Sin nombre científico'}</h6>
                                                    <p class="card-text">
                                                        <strong>Categoría:</strong> ${escapeHTML(item.Categoría) || 'No especificada'}<br>
                                                        <strong>Tipo:</strong> ${escapeHTML(item.Tipo) || 'No especificado'}
                                                    </p>
                                                </div>
                                            </div>
                                        </a>
                                    </div>
                                `;
                            });

                            resultsHTML += '</div>';
                            resultContainer.innerHTML = resultsHTML;
                        } else {
                            resultContainer.innerHTML = '<div class="alert alert-info">No se encontraron resultados.</div>';
                        }
                    })
                    .catch(error => {
                        resultContainer.innerHTML = `<div class="alert alert-danger">Error al realizar la solicitud: ${error.message}</div>`;
                    });
                });

                function escapeHTML(str) {
                    if (!str) return '';
                    return str.toString()
                        .replace(/&/g, '&amp;')
                        .replace(/</g, '&lt;')
                        .replace(/>/g, '&gt;')
                        .replace(/"/g, '&quot;')
                        .replace(/'/g, '&#039;');
                }
            });
        </script>
    
        <!-- Template Main JS File -->
        <script src="assets/js/main.js"></script>
    </body>
</html>
